<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supermercado Plus - Com Supabase</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            flex-direction: column;
        }

        .auth-screen {
            display: flex;
            height: 100vh;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        .auth-box h1 {
            color: #667eea;
            margin-bottom: 30px;
            text-align: center;
            font-size: 28px;
        }

        .auth-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .auth-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .auth-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .auth-buttons button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-login {
            background: #667eea;
            color: white;
        }

        .btn-login:hover {
            background: #5568d3;
        }

        .btn-register {
            background: #e0e0e0;
            color: #333;
        }

        .btn-register:hover {
            background: #d0d0d0;
        }

        .auth-message {
            text-align: center;
            color: #666;
            font-size: 13px;
        }

        .auth-message.error {
            color: #f44336;
            padding: 10px;
            background: #ffebee;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .auth-message.success {
            color: #4caf50;
            padding: 10px;
            background: #f0f8f0;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .btn-forgot-password {
            width: 100%;
            padding: 10px;
            background: transparent;
            color: #667eea;
            border: none;
            font-size: 12px;
            cursor: pointer;
            text-decoration: underline;
            transition: all 0.3s ease;
        }

        .btn-forgot-password:hover {
            color: #5568d3;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-box {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 350px;
        }

        .modal-box h2 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
            font-size: 20px;
        }

        .modal-box input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        .modal-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-message {
            text-align: center;
            font-size: 12px;
            margin-bottom: 15px;
            color: #666;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-buttons button {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-confirm {
            background: #667eea;
            color: white;
        }

        .btn-confirm:hover {
            background: #5568d3;
        }

        .btn-cancel {
            background: #e0e0e0;
            color: #333;
        }

        .btn-cancel:hover {
            background: #d0d0d0;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            margin: 0;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .user-email {
            font-size: 12px;
            opacity: 0.9;
        }

        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-logout:hover {
            background: rgba(255,255,255,0.3);
        }

        .tabs {
            display: flex;
            gap: 0;
            border-bottom: 2px solid #ddd;
            background: white;
            padding: 0 15px;
        }

        .tab {
            flex: 1;
            padding: 15px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .list-header {
            background: #f8f9fa;
            padding: 12px 15px;
            font-weight: 600;
            display: grid;
            grid-template-columns: 1fr 80px 100px 80px;
            gap: 10px;
            border-bottom: 1px solid #eee;
            border-radius: 8px 8px 0 0;
        }

        .list-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            display: grid;
            grid-template-columns: 1fr 80px 100px 80px;
            gap: 10px;
            align-items: center;
            transition: background 0.2s ease;
            background: white;
        }

        .list-item:hover {
            background: #f8f9fa;
        }

        .list-item.purchased {
            opacity: 0.6;
            background: #f0f8f0;
        }

        .list-item.purchased .item-name {
            text-decoration: line-through;
            color: #999;
        }

        .item-name {
            font-weight: 500;
            word-break: break-word;
        }

        .item-category {
            font-size: 12px;
            color: #999;
            margin-top: 3px;
        }

        .item-quantity {
            text-align: center;
            font-weight: 500;
        }

        .item-value {
            text-align: right;
            font-weight: 500;
            color: #667eea;
        }

        .item-value-calc {
            display: flex;
            flex-direction: column;
            gap: 3px;
            text-align: right;
        }

        .item-value-unit {
            font-size: 11px;
            color: #999;
        }

        .item-value-total {
            font-weight: 600;
            color: #667eea;
        }

        .item-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }

        .btn-small {
            padding: 6px 10px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-check {
            background: #4caf50;
            color: white;
        }

        .btn-check:hover {
            background: #45a049;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #da190b;
        }

        .btn-primary {
            background: #667eea;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .new-list-form {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            gap: 8px;
            flex-direction: column;
            margin-bottom: 15px;
        }

        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .section-title {
            font-size: 16px;
            font-weight: 600;
            margin: 20px 0 15px 0;
            color: #333;
        }

        .list-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .list-btn {
            padding: 8px 15px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .list-btn:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .list-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .list-btn.delete-list {
            background: #ffebee;
            border-color: #f44336;
            color: #f44336;
            font-size: 12px;
            padding: 8px 10px;
        }

        .list-btn.delete-list:hover {
            background: #f44336;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .summary {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .summary-item {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .summary-label {
            font-size: 12px;
            color: #999;
            margin-bottom: 8px;
        }

        .summary-value {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }

        .statistics {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
        }

        .stat-card {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .stat-label {
            font-size: 11px;
            color: #999;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 16px;
            font-weight: 700;
            color: #667eea;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .sync-indicator {
            font-size: 11px;
            color: #999;
            margin-top: 8px;
        }

        .sync-indicator.syncing {
            color: #667eea;
        }

        .share-buttons {
            margin-top: 15px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .btn-share {
            flex: 1;
            min-width: 140px;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-share-whatsapp {
            background: #25d366;
            color: white;
        }

        .btn-share-whatsapp:hover {
            background: #20ba5a;
        }

        .btn-share-email {
            background: #4caf50;
            color: white;
        }

        .btn-share-email:hover {
            background: #45a049;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            max-width: 300px;
        }

        .notification.success {
            border-left: 4px solid #4caf50;
            color: #4caf50;
        }

        .notification.error {
            border-left: 4px solid #f44336;
            color: #f44336;
        }

        .notification.info {
            border-left: 4px solid #667eea;
            color: #667eea;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 18px;
            }

            .header {
                padding: 12px 15px;
            }

            .content {
                padding: 12px;
            }

            .list-header,
            .list-item {
                grid-template-columns: 1fr 50px;
                padding: 10px 12px;
                font-size: 13px;
            }

            .item-actions {
                grid-column: 1 / -1;
                justify-content: flex-start;
                margin-top: 8px;
                gap: 4px;
            }

            .tab {
                padding: 12px 8px;
                font-size: 12px;
            }

            .auth-box {
                padding: 30px 20px;
                max-width: 90%;
            }

            .modal-box {
                max-width: 85%;
            }

            .share-buttons {
                flex-direction: column;
            }

            .btn-share {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- AUTH SCREEN -->
    <div id="authScreen" class="auth-screen">
        <div class="auth-box">
            <h1>üõí Supermercado Plus</h1>
            <div id="authMessage"></div>
            <input 
                type="email" 
                id="authEmail" 
                placeholder="Email"
                onkeypress="handleAuthKeypress(event)"
            >
            <input 
                type="password" 
                id="authPassword" 
                placeholder="Senha"
                onkeypress="handleAuthKeypress(event)"
            >
            <div class="auth-buttons">
                <button class="btn-login" onclick="handleLogin()">Login</button>
                <button class="btn-register" onclick="handleRegister()">Registrar</button>
            </div>
            <p class="auth-message">Use email e senha para entrar</p>
            <button class="btn-forgot-password" onclick="showForgotPasswordModal()">Esqueceu a senha?</button>
        </div>
    </div>

    <!-- MODAL REDEFINIR SENHA -->
    <div id="forgotPasswordModal" class="modal-overlay">
        <div class="modal-box">
            <h2>Redefinir Senha</h2>
            <div id="forgotPasswordMessage"></div>
            <p class="modal-message">Digite seu email para receber um link de redefini√ß√£o</p>
            <input 
                type="email" 
                id="forgotPasswordEmail" 
                placeholder="Seu email"
                onkeypress="handleForgotPasswordKeypress(event)"
            >
            <div class="modal-buttons">
                <button class="btn-confirm" onclick="sendPasswordResetEmail()">Enviar Link</button>
                <button class="btn-cancel" onclick="closeForgotPasswordModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- MODAL NOVA SENHA -->
    <div id="resetPasswordModal" class="modal-overlay">
        <div class="modal-box">
            <h2>Nova Senha</h2>
            <div id="resetPasswordMessage"></div>
            <p class="modal-message">Defina sua nova senha</p>
            <input 
                type="password" 
                id="newPassword" 
                placeholder="Nova senha"
                onkeypress="handleResetPasswordKeypress(event)"
            >
            <input 
                type="password" 
                id="confirmPassword" 
                placeholder="Confirmar senha"
                onkeypress="handleResetPasswordKeypress(event)"
            >
            <div class="modal-buttons">
                <button class="btn-confirm" onclick="updatePassword()">Atualizar Senha</button>
                <button class="btn-cancel" onclick="closeResetPasswordModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- APP SCREEN -->
    <div id="appScreen" class="container" style="display: none;">
        <div class="header">
            <h1>üõí Supermercado Plus</h1>
            <div class="user-info">
                <div class="user-email" id="userEmail"></div>
                <button class="btn-logout" onclick="handleLogout()">Sair</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" data-tab="shopping" onclick="switchTab('shopping')">Compras</div>
            <div class="tab" data-tab="stock" onclick="switchTab('stock')">Estoque</div>
        </div>

        <div class="content">
            <!-- TAB: SHOPPING LISTS -->
            <div id="shopping" class="tab-content active">
                <div class="new-list-form">
                    <h3 style="margin-bottom: 15px;">Nova Lista</h3>
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="newListName" 
                            placeholder="Nome da lista"
                            maxlength="30"
                        >
                        <button class="btn-primary" onclick="createNewList()" style="width: 100%;">Criar Lista</button>
                    </div>
                </div>

                <div class="section-title">Minhas Listas</div>
                <div class="list-selector" id="listSelector"></div>

                <div id="noListsMessage" class="empty-state">
                    <p>üìã Crie uma lista para come√ßar</p>
                </div>

                <div id="listContent" style="display: none;">
                    <div id="statisticsContainer" class="statistics" style="display: none;"></div>

                    <div class="section-title">Adicionar Item</div>
                    <div class="new-list-form">
                        <div class="input-group">
                            <input 
                                type="text" 
                                id="itemName" 
                                placeholder="Nome do item (ex: 12 leites)"
                                maxlength="50"
                                onkeyup="autoSuggestCategory()"
                            >
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <select id="itemCategory">
                                <option value="">Categoria</option>
                                <option value="Padaria">ü•ê Padaria</option>
                                <option value="Hortifruti">ü•¨ Hortifruti</option>
                                <option value="Legumes">üåæ Legumes</option>
                                <option value="Prote√≠nas">üçó Prote√≠nas</option>
                                <option value="Latic√≠nios">üßÄ Latic√≠nios</option>
                                <option value="Bebidas">ü•§ Bebidas</option>
                                <option value="Doces e Lanches">üç™ Doces e Lanches</option>
                                <option value="Congelados">‚ùÑÔ∏è Congelados</option>
                                <option value="Limpeza">üßπ Limpeza</option>
                                <option value="Higiene">üßº Higiene</option>
                                <option value="Outros">üì¶ Outros</option>
                            </select>
                            <input 
                                type="number" 
                                id="itemQuantity" 
                                placeholder="Qtd"
                                min="1"
                                value="1"
                            >
                        </div>
                        <input 
                            type="number" 
                            id="itemValue" 
                            placeholder="Valor unit√°rio (R$)"
                            step="0.01"
                            min="0"
                        >
                        <button class="btn-primary" onclick="addItem()" style="width: 100%; margin-top: 10px;">Adicionar</button>
                    </div>

                    <div id="itemsContainer" style="margin-top: 20px;">
                        <div class="list-header">
                            <div>Item</div>
                            <div>Qtd.</div>
                            <div>Valor</div>
                            <div>A√ß√µes</div>
                        </div>
                        <div id="itemsList"></div>
                    </div>

                    <div id="summaryContainer" class="summary" style="display: none;">
                        <div class="summary-item">
                            <div class="summary-label">Total de Itens</div>
                            <div class="summary-value" id="totalItems">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Itens Comprados</div>
                            <div class="summary-value" id="purchasedItems">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-label">Valor Total</div>
                            <div class="summary-value" id="totalValue">R$ 0,00</div>
                        </div>
                    </div>

                    <div class="sync-indicator" id="syncStatus">‚úì Sincronizado</div>

                    <div class="share-buttons">
                        <button class="btn-share btn-share-whatsapp" onclick="shareList('whatsapp')">
                            üì± Compartilhar no WhatsApp
                        </button>
                        <button class="btn-share btn-share-email" onclick="shareList('email')">
                            ‚úâÔ∏è Compartilhar por Email
                        </button>
                    </div>
                </div>
            </div>

            <!-- TAB: STOCK -->
            <div id="stock" class="tab-content">
                <div class="new-list-form">
                    <h3 style="margin-bottom: 15px;">Adicionar ao Estoque</h3>
                    <div class="input-group">
                        <input 
                            type="text" 
                            id="stockItemName" 
                            placeholder="Nome do item"
                            maxlength="50"
                        >
                        <input 
                            type="number" 
                            id="stockItemQuantity" 
                            placeholder="Quantidade"
                            min="1"
                            value="1"
                        >
                        <select id="stockItemCategory">
                            <option value="">Categoria</option>
                            <option value="Padaria">ü•ê Padaria</option>
                            <option value="Hortifruti">ü•¨ Hortifruti</option>
                            <option value="Legumes">üåæ Legumes</option>
                            <option value="Prote√≠nas">üçó Prote√≠nas</option>
                            <option value="Latic√≠nios">üßÄ Latic√≠nios</option>
                            <option value="Bebidas">ü•§ Bebidas</option>
                            <option value="Doces e Lanches">üç™ Doces e Lanches</option>
                            <option value="Congelados">‚ùÑÔ∏è Congelados</option>
                            <option value="Limpeza">üßπ Limpeza</option>
                            <option value="Higiene">üßº Higiene</option>
                            <option value="Outros">üì¶ Outros</option>
                        </select>
                        <input 
                            type="text" 
                            id="stockItemNotes" 
                            placeholder="Notas"
                            maxlength="100"
                        >
                        <button class="btn-primary" onclick="addStockItem()" style="width: 100%;">Adicionar ao Estoque</button>
                    </div>
                </div>

                <div class="section-title">Itens em Estoque</div>
                <div id="stockContainer"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/+esm';

        const SUPABASE_URL = 'https://ozwqghlhtaigiesnaphn.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_kYhFng_sQiFRzqz4snW2GA_s3a8W08-';

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentListId = null;
        let lists = [];
        let items = [];
        let stockItems = [];
        let authInitialized = false;

        const productCategoryMap = {
            'p√£o': 'Padaria', 'p√£o franc√™s': 'Padaria', 'baguete': 'Padaria',
            'ma√ß√£': 'Hortifruti', 'banana': 'Hortifruti', 'laranja': 'Hortifruti',
            'arroz': 'Legumes', 'feij√£o': 'Legumes', 'macarr√£o': 'Legumes',
            'frango': 'Prote√≠nas', 'carne': 'Prote√≠nas', 'peixe': 'Prote√≠nas',
            'leite': 'Latic√≠nios', 'queijo': 'Latic√≠nios', 'iogurte': 'Latic√≠nios',
            '√°gua': 'Bebidas', 'suco': 'Bebidas', 'refrigerante': 'Bebidas',
            'chocolate': 'Doces e Lanches', 'bolo': 'Doces e Lanches',
            'sorvete': 'Congelados', 'pizza': 'Congelados',
            'detergente': 'Limpeza', 'sab√£o': 'Limpeza',
            'shampoo': 'Higiene', 'sabonete': 'Higiene'
        };

        // ===== REDEFINIR SENHA =====
        function checkPasswordResetToken() {
            const urlParams = new URLSearchParams(window.location.hash.substring(1));
            const type = urlParams.get('type');
            const accessToken = urlParams.get('access_token');
            
            if (type === 'recovery' && accessToken) {
                setTimeout(() => {
                    document.getElementById('resetPasswordModal').classList.add('active');
                }, 500);
            }
        }

        function showForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.add('active');
            document.getElementById('forgotPasswordEmail').focus();
            document.getElementById('forgotPasswordMessage').textContent = '';
        }

        function closeForgotPasswordModal() {
            document.getElementById('forgotPasswordModal').classList.remove('active');
            document.getElementById('forgotPasswordEmail').value = '';
            document.getElementById('forgotPasswordMessage').textContent = '';
        }

        function closeResetPasswordModal() {
            document.getElementById('resetPasswordModal').classList.remove('active');
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            document.getElementById('resetPasswordMessage').textContent = '';
        }

        function handleForgotPasswordKeypress(e) {
            if (e.key === 'Enter') {
                sendPasswordResetEmail();
            }
        }

        function handleResetPasswordKeypress(e) {
            if (e.key === 'Enter') {
                updatePassword();
            }
        }

        async function sendPasswordResetEmail() {
            const email = document.getElementById('forgotPasswordEmail').value.trim();
            
            if (!email) {
                showForgotPasswordMessage('Preencha seu email', 'error');
                return;
            }

            const { error } = await supabase.auth.resetPasswordForEmail(email, {
                redirectTo: window.location.origin
            });

            if (error) {
                showForgotPasswordMessage('Erro: ' + error.message, 'error');
            } else {
                showForgotPasswordMessage('Link enviado! Verifique seu email', 'success');
                setTimeout(() => {
                    closeForgotPasswordModal();
                }, 2000);
            }
        }

        async function updatePassword() {
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                showResetPasswordMessage('Preencha ambos os campos', 'error');
                return;
            }
            
            if (newPassword.length < 6) {
                showResetPasswordMessage('Senha deve ter no m√≠nimo 6 caracteres', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showResetPasswordMessage('As senhas n√£o conferem', 'error');
                return;
            }
            
            const { error } = await supabase.auth.updateUser({ 
                password: newPassword 
            });
            
            if (error) {
                showResetPasswordMessage('Erro: ' + error.message, 'error');
            } else {
                showResetPasswordMessage('‚úì Senha atualizada com sucesso!', 'success');
                window.location.hash = '';
                setTimeout(() => {
                    closeResetPasswordModal();
                    document.getElementById('authScreen').style.display = 'flex';
                    document.getElementById('appScreen').style.display = 'none';
                    showAuthMessage('Senha redefinida! Fa√ßa login com a nova senha', 'success');
                }, 2000);
            }
        }

        function showForgotPasswordMessage(msg, type) {
            const msgDiv = document.getElementById('forgotPasswordMessage');
            msgDiv.textContent = msg;
            msgDiv.className = type === 'error' ? 'auth-message error' : 'auth-message success';
        }

        function showResetPasswordMessage(msg, type) {
            const msgDiv = document.getElementById('resetPasswordMessage');
            msgDiv.textContent = msg;
            msgDiv.className = type === 'error' ? 'auth-message error' : 'auth-message success';
        }

        // ===== AUTH =====
        async function handleLogin() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value.trim();

            if (!email || !password) {
                showAuthMessage('Preencha email e senha', 'error');
                return;
            }

            const { data, error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                showAuthMessage(error.message, 'error');
            } else {
                currentUser = data.user;
                await loadApp();
            }
        }

        async function handleRegister() {
            const email = document.getElementById('authEmail').value.trim();
            const password = document.getElementById('authPassword').value.trim();

            if (!email || !password) {
                showAuthMessage('Preencha email e senha', 'error');
                return;
            }

            const { data, error } = await supabase.auth.signUp({ email, password });
            if (error) {
                showAuthMessage(error.message, 'error');
            } else {
                showAuthMessage('Registrado com sucesso! Fa√ßa login agora', 'success');
                document.getElementById('authEmail').value = '';
                document.getElementById('authPassword').value = '';
            }
        }

        async function handleLogout() {
            const { error } = await supabase.auth.signOut();
            
            if (error) {
                console.error('Erro ao deslogar:', error);
                return;
            }

            currentUser = null;
            currentListId = null;
            lists = [];
            items = [];
            stockItems = [];

            document.getElementById('authScreen').style.display = 'flex';
            document.getElementById('appScreen').style.display = 'none';
            document.getElementById('authEmail').value = '';
            document.getElementById('authPassword').value = '';
            document.getElementById('authMessage').textContent = '';
        }

        function handleAuthKeypress(e) {
            if (e.key === 'Enter') {
                const email = document.getElementById('authEmail').value.trim();
                const password = document.getElementById('authPassword').value.trim();
                if (email && password) {
                    handleLogin();
                }
            }
        }

        function showAuthMessage(msg, type) {
            const msgDiv = document.getElementById('authMessage');
            msgDiv.textContent = msg;
            msgDiv.className = type === 'error' ? 'auth-message error' : 'auth-message success';
            setTimeout(() => { msgDiv.textContent = ''; msgDiv.className = ''; }, 4000);
        }

        // ===== APP =====
        async function loadApp() {
            document.getElementById('authScreen').style.display = 'none';
            document.getElementById('appScreen').style.display = 'flex';
            document.getElementById('userEmail').textContent = currentUser.email;
            await loadLists();
            setupRealtimeListeners();
        }

        async function loadLists() {
            const { data, error } = await supabase
                .from('shopping_lists')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('created_at', { ascending: false });

            if (!error) {
                lists = data || [];
                updateListSelector();
                if (lists.length > 0 && !currentListId) {
                    currentListId = lists[0].id;
                    await loadItems();
                }
            }
        }

        async function loadItems() {
            if (!currentListId) return;

            const { data, error } = await supabase
                .from('shopping_items')
                .select('*')
                .eq('list_id', currentListId)
                .order('created_at', { ascending: true });

            if (!error) {
                items = data || [];
                updateListDisplay();
            }
        }

        async function loadStockItems() {
            const { data, error } = await supabase
                .from('stock_items')
                .select('*')
                .eq('user_id', currentUser.id)
                .order('added_at', { ascending: false });

            if (!error) {
                stockItems = data || [];
                updateStockDisplay();
            }
        }

        function setupRealtimeListeners() {
            supabase
                .channel('shopping_items_changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'shopping_items' },
                    () => { loadItems(); }
                )
                .subscribe();

            supabase
                .channel('stock_items_changes')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'stock_items' },
                    () => { loadStockItems(); }
                )
                .subscribe();
        }

        async function createNewList() {
            const name = document.getElementById('newListName').value.trim();
            if (!name) {
                showNotification('Digite um nome para a lista', 'error');
                return;
            }

            const { data, error } = await supabase
                .from('shopping_lists')
                .insert({ name, user_id: currentUser.id })
                .select();

            if (!error) {
                document.getElementById('newListName').value = '';
                await loadLists();
                showNotification('Lista criada com sucesso!', 'success');
            }
        }

        function updateListSelector() {
            const selector = document.getElementById('listSelector');
            selector.innerHTML = '';

            lists.forEach(list => {
                const btn = document.createElement('button');
                btn.className = 'list-btn' + (list.id === currentListId ? ' active' : '');
                btn.textContent = list.name;
                btn.onclick = async (e) => {
                    e.stopPropagation();
                    currentListId = list.id;
                    await loadItems();
                    updateListSelector();
                };

                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'list-btn delete-list';
                deleteBtn.textContent = '‚úï';
                deleteBtn.onclick = async (e) => {
                    e.stopPropagation();
                    if (confirm('Deletar esta lista?')) {
                        await supabase.from('shopping_lists').delete().eq('id', list.id);
                        if (currentListId === list.id) {
                            currentListId = null;
                        }
                        await loadLists();
                    }
                };

                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';
                wrapper.appendChild(btn);
                wrapper.appendChild(deleteBtn);
                selector.appendChild(wrapper);
            });

            if (lists.length === 0) {
                document.getElementById('noListsMessage').style.display = 'block';
                document.getElementById('listContent').style.display = 'none';
            } else {
                document.getElementById('noListsMessage').style.display = 'none';
                document.getElementById('listContent').style.display = 'block';
            }
        }

        function autoSuggestCategory() {
            const name = document.getElementById('itemName').value.toLowerCase().trim();
            const select = document.getElementById('itemCategory');
            
            for (const [key, category] of Object.entries(productCategoryMap)) {
                if (name.includes(key) || key.includes(name)) {
                    select.value = category;
                    return;
                }
            }
        }

        async function addItem() {
            const name = document.getElementById('itemName').value.trim();
            const category = document.getElementById('itemCategory').value;
            const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;
            const unitValue = parseFloat(document.getElementById('itemValue').value) || 0;

            // Valida√ß√µes
            if (!name) {
                showNotification('‚ùå Digite o nome do item (ex: 12 leites)', 'error');
                return;
            }

            if (!currentListId) {
                showNotification('‚ùå Selecione uma lista primeiro', 'error');
                return;
            }

            if (unitValue <= 0) {
                showNotification('‚ùå Digite um valor unit√°rio v√°lido (maior que 0)', 'error');
                return;
            }

            if (quantity <= 0) {
                showNotification('‚ùå A quantidade deve ser maior que 0', 'error');
                return;
            }

            const totalItemValue = quantity * unitValue;

            try {
                const { data, error } = await supabase
                    .from('shopping_items')
                    .insert({
                        list_id: currentListId,
                        name,
                        category: category || null,
                        quantity,
                        unit_value: unitValue,
                        value: totalItemValue,
                        purchased: false
                    })
                    .select();

                if (error) {
                    console.error('Erro ao inserir:', error);
                    showNotification('‚ùå Erro ao adicionar: ' + error.message, 'error');
                    return;
                }

                // Limpar campos
                document.getElementById('itemName').value = '';
                document.getElementById('itemCategory').value = '';
                document.getElementById('itemQuantity').value = '1';
                document.getElementById('itemValue').value = '';
                
                // Recarregar lista
                await loadItems();
                showNotification(`‚úì ${name} (${quantity}x) adicionado por R$ ${totalItemValue.toFixed(2).replace('.', ',')}!`, 'success');
            } catch (err) {
                console.error('Erro ao adicionar item:', err);
                showNotification('‚ùå Erro ao adicionar item', 'error');
            }
        }

        async function togglePurchased(itemId) {
            const item = items.find(i => i.id === itemId);
            if (item) {
                await supabase
                    .from('shopping_items')
                    .update({ purchased: !item.purchased })
                    .eq('id', itemId);
                await loadItems();
            }
        }

        async function deleteItem(itemId) {
            await supabase.from('shopping_items').delete().eq('id', itemId);
            await loadItems();
        }

        function updateListDisplay() {
            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = '';

            if (items.length === 0) {
                itemsList.innerHTML = '<div class="empty-state" style="padding: 20px;">Nenhum item</div>';
            } else {
                items.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'list-item' + (item.purchased ? ' purchased' : '');
                    
                    const unitValueStr = item.unit_value > 0 ? `R$ ${item.unit_value.toFixed(2).replace('.', ',')}` : '‚Äî';
                    const totalValueStr = item.value > 0 ? `R$ ${item.value.toFixed(2).replace('.', ',')}` : '‚Äî';
                    
                    div.innerHTML = `
                        <div>
                            <div class="item-name">${item.name}</div>
                            ${item.category ? `<div class="item-category">${item.category}</div>` : ''}
                        </div>
                        <div class="item-quantity">${item.quantity}x</div>
                        <div class="item-value-calc">
                            <div class="item-value-unit">${unitValueStr}</div>
                            <div class="item-value-total">${totalValueStr}</div>
                        </div>
                        <div class="item-actions">
                            <button class="btn-small btn-check" onclick="togglePurchased('${item.id}')">
                                ${item.purchased ? '‚úì' : '‚óã'}
                            </button>
                            <button class="btn-small btn-delete" onclick="deleteItem('${item.id}')">‚úï</button>
                        </div>
                    `;
                    itemsList.appendChild(div);
                });
            }

            const total = items.length;
            const purchased = items.filter(i => i.purchased).length;
            const totalValue = items.reduce((sum, i) => sum + (i.value || 0), 0);
            const spentValue = items.filter(i => i.purchased).reduce((sum, i) => sum + (i.value || 0), 0);
            const remainingValue = totalValue - spentValue;

            document.getElementById('totalItems').textContent = total;
            document.getElementById('purchasedItems').textContent = purchased;
            document.getElementById('totalValue').textContent = `R$ ${totalValue.toFixed(2).replace('.', ',')}`;
            
            updateStatistics(total, purchased, totalValue, spentValue, remainingValue);
            document.getElementById('summaryContainer').style.display = total > 0 ? 'grid' : 'none';
        }

        function updateStatistics(total, purchased, totalValue, spentValue, remainingValue) {
            const statsContainer = document.getElementById('statisticsContainer');
            
            if (total === 0) {
                statsContainer.style.display = 'none';
                return;
            }
            
            const percentagePurchased = Math.round((purchased / total) * 100);
            const percentageSpent = Math.round((spentValue / totalValue) * 100) || 0;
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total de Itens</div>
                    <div class="stat-value">${total}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Comprados</div>
                    <div class="stat-value">${purchased} (${percentagePurchased}%)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Valor Total</div>
                    <div class="stat-value">R$ ${totalValue.toFixed(2).replace('.', ',')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">J√° Gasto</div>
                    <div class="stat-value">R$ ${spentValue.toFixed(2).replace('.', ',')} (${percentageSpent}%)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">A Gastar</div>
                    <div class="stat-value">R$ ${remainingValue.toFixed(2).replace('.', ',')}</div>
                </div>
            `;
            
            statsContainer.style.display = 'grid';
        }

        function showNotification(msg, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = msg;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        async function addStockItem() {
            const name = document.getElementById('stockItemName').value.trim();
            const quantity = parseInt(document.getElementById('stockItemQuantity').value) || 1;
            const category = document.getElementById('stockItemCategory').value;
            const notes = document.getElementById('stockItemNotes').value.trim();

            if (!name) {
                showNotification('Digite o nome do item', 'error');
                return;
            }

            await supabase
                .from('stock_items')
                .insert({ name, quantity, category, notes, user_id: currentUser.id });

            document.getElementById('stockItemName').value = '';
            document.getElementById('stockItemQuantity').value = '1';
            document.getElementById('stockItemCategory').value = '';
            document.getElementById('stockItemNotes').value = '';
            await loadStockItems();
            showNotification('‚úì Item adicionado ao estoque!', 'success');
        }

        async function deleteStockItem(itemId) {
            await supabase.from('stock_items').delete().eq('id', itemId);
            await loadStockItems();
        }

        function updateStockDisplay() {
            const container = document.getElementById('stockContainer');
            
            if (stockItems.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Estoque vazio</p></div>';
                return;
            }

            const grouped = {};
            stockItems.forEach(item => {
                const category = item.category || 'Outros';
                if (!grouped[category]) grouped[category] = [];
                grouped[category].push(item);
            });

            container.innerHTML = Object.entries(grouped).map(([category, items]) => `
                <div class="section-title">${category}</div>
                ${items.map(item => `
                    <div style="background: white; padding: 15px; border-radius: 6px; margin-bottom: 10px; display: flex; justify-content: space-between; border-left: 4px solid #667eea;">
                        <div>
                            <h3 style="margin: 0 0 5px 0; color: #333; font-size: 14px;">${item.name}</h3>
                            <p style="margin: 0; font-size: 12px; color: #999;">Qtd: ${item.quantity}x ${item.notes ? '| üìå ' + item.notes : ''}</p>
                        </div>
                        <button class="btn-small btn-delete" onclick="deleteStockItem('${item.id}')">Remover</button>
                    </div>
                `).join('')}
            `).join('');
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tab).classList.add('active');
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            if (tab === 'stock') {
                loadStockItems();
            }
        }

        function buildShareText() {
            if (!currentListId || items.length === 0) {
                showNotification('Nenhum item na lista para compartilhar', 'error');
                return null;
            }

            const currentList = lists.find(l => l.id === currentListId);
            const listName = currentList ? currentList.name : 'Minha Lista';

            const totalValue = items.reduce((sum, i) => sum + (i.value || 0), 0);
            const purchased = items.filter(i => i.purchased).length;

            let lines = [];
            lines.push(`LISTA: ${listName}`);
            lines.push('');
            lines.push('ITENS:');
            items.forEach(i => {
                const valueStr = i.value > 0 ? ` - R$ ${i.value.toFixed(2).replace('.', ',')}` : '';
                const status = i.purchased ? '[X]' : '[ ]';
                lines.push(`${status} ${i.name} (${i.quantity}x)${valueStr}`);
            });
            lines.push('');
            lines.push(`RESUMO:`);
            lines.push(`Itens comprados: ${purchased}/${items.length}`);
            lines.push(`Valor total: R$ ${totalValue.toFixed(2).replace('.', ',')}`);

            return lines.join('\n');
        }

        function shareList(type) {
            const text = buildShareText();
            if (!text) return;

            if (type === 'whatsapp') {
                const url = 'https://wa.me/?text=' + encodeURIComponent(text);
                window.open(url, '_blank');
            } else if (type === 'email') {
                const subject = encodeURIComponent('Lista de Compras - Supermercado Plus');
                const url = 'mailto:?subject=' + subject + '&body=' + encodeURIComponent(text);
                window.location.href = url;
            }
        }

        supabase.auth.onAuthStateChange(async (event, session) => {
            if (authInitialized) return;
            
            if (session && session.user) {
                authInitialized = true;
                currentUser = session.user;
                await loadApp();
            }
        });

        checkPasswordResetToken();

        window.handleLogin = handleLogin;
        window.handleRegister = handleRegister;
        window.handleLogout = handleLogout;
        window.handleAuthKeypress = handleAuthKeypress;
        window.showForgotPasswordModal = showForgotPasswordModal;
        window.closeForgotPasswordModal = closeForgotPasswordModal;
        window.handleForgotPasswordKeypress = handleForgotPasswordKeypress;
        window.sendPasswordResetEmail = sendPasswordResetEmail;
        window.handleResetPasswordKeypress = handleResetPasswordKeypress;
        window.updatePassword = updatePassword;
        window.closeResetPasswordModal = closeResetPasswordModal;
        window.createNewList = createNewList;
        window.addItem = addItem;
        window.togglePurchased = togglePurchased;
        window.deleteItem = deleteItem;
        window.autoSuggestCategory = autoSuggestCategory;
        window.addStockItem = addStockItem;
        window.deleteStockItem = deleteStockItem;
        window.switchTab = switchTab;
        window.shareList = shareList;
        window.showNotification = showNotification;
        window.updateStatistics = updateStatistics;
    </script>
</body>
</html>
